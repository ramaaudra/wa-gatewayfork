<!-- Load media functions first -->
<script src="/assets/js/media-functions.js"></script>

<div class="page-heading">
  <div class="page-title">
    <div class="row">
      <div class="col-12 col-md-6 order-md-1 order-last">
        <h3>
          <% if (user && user.username) { %> <%= user.username %>'s <% } %>Media
          Library
        </h3>
        <p class="text-subtitle text-muted">
          Manage your media files for messages and auto-replies.
        </p>
      </div>
      <div class="col-12 col-md-6 order-md-2 order-first">
        <nav
          aria-label="breadcrumb"
          class="breadcrumb-header float-start float-lg-end"
        >
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">
              Media Library
            </li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
</div>

<section class="section">
  <div class="card">
    <div class="card-header">
      <h4 class="card-title">Your Media Files</h4>
      <button
        type="button"
        class="btn btn-primary float-end"
        data-bs-toggle="modal"
        data-bs-target="#addMediaModal"
      >
        <i class="bi bi-plus-circle"></i> Add New Media
      </button>
    </div>
    <div class="card-body">
      <table class="table table-striped" id="mediaTable">
        <thead>
          <tr>
            <th>Preview</th>
            <th>Name</th>
            <th>File Name</th>
            <th>Type</th>
            <th>Size</th>
            <th>Upload Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (mediaItems && mediaItems.length > 0) { %> <%
          mediaItems.forEach(media => { %>
          <tr id="mediaRow_<%= media.id %>">
            <td>
              <% if (media.mime_type && media.mime_type.startsWith('image/')) {
              %>
              <img
                src="<%= baseUrl %>/media/library/<%= media.file_name %>"
                alt="<%= media.name %>"
                width="50"
                height="50"
                style="object-fit: cover"
              />
              <% } else if (media.mime_type &&
              media.mime_type.startsWith('video/')) { %>
              <video width="50" height="50" controls>
                <source
                  src="<%= baseUrl %>/media/library/<%= media.file_name %>"
                  type="<%= media.mime_type %>"
                />
                Your browser does not support the video tag.
              </video>
              <% } else if (media.mime_type &&
              media.mime_type.startsWith('audio/')) { %>
              <audio controls>
                <source
                  src="<%= baseUrl %>/media/library/<%= media.file_name %>"
                  type="<%= media.mime_type %>"
                />
                Your browser does not support the audio tag.
              </audio>
              <% } else { %>
              <i class="bi bi-file-earmark-fill fs-3"></i>
              <% } %>
            </td>
            <td><%= media.name %></td>
            <td><%= media.file_name %></td>
            <td><%= media.mime_type %></td>
            <td><%= (media.size / 1024).toFixed(2) %> KB</td>
            <td><%= new Date(media.upload_date).toLocaleDateString() %></td>
            <td>
              <a
                href="javascript:void(0)"
                onclick="editMedia('<%= media.id %>', '<%= media.name %>', '<%= media.description || '' %>', '<%= media.file_name %>', '<%= media.mime_type %>', '<%= media.size %>')"
                class="btn btn-sm btn-info me-1"
              >
                <i class="bi bi-pencil-square"></i>
              </a>
              <a
                href="javascript:void(0)"
                onclick="confirmDelete('<%= media.id %>')"
                class="btn btn-sm btn-danger"
              >
                <i class="bi bi-trash-fill"></i>
              </a>
            </td>
          </tr>
          <% }) %> <% } else { %>
          <tr>
            <td colspan="7" class="text-center">No media files found.</td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Add Media Modal -->
<div class="modal fade" id="addMediaModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Media</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form
          id="addMediaForm"
          action="/dashboard/media-library/upload"
          method="POST"
          enctype="multipart/form-data"
        >
          <div class="form-group">
            <label for="name">Media Name</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
          </div>
          <div class="form-group mt-3">
            <label for="description">Description</label>
            <textarea
              class="form-control"
              id="description"
              name="description"
              rows="3"
            ></textarea>
          </div>
          <div class="form-group mt-3">
            <label for="file">File</label>
            <input
              type="file"
              class="form-control"
              id="file"
              name="file"
              required
            />
          </div>
          <div class="preview-container mt-3"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Media Modal -->
<div
  class="modal fade"
  id="editMediaModal"
  tabindex="-1"
  aria-labelledby="editMediaModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editMediaModalLabel">Edit Media</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form
        id="editMediaForm"
        method="POST"
        action="#"
        enctype="multipart/form-data"
      >
        <input type="hidden" id="editMediaId" name="id" />
        <div class="modal-body">
          <div class="mb-3">
            <label for="editMediaName" class="form-label">Media Name</label>
            <input
              type="text"
              class="form-control"
              id="editMediaName"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editMediaDescription" class="form-label"
              >Description (Optional)</label
            >
            <textarea
              class="form-control"
              id="editMediaDescription"
              name="description"
              rows="3"
            ></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Current File</label>
            <div id="currentMediaPreview"></div>
          </div>
          <div class="mb-3">
            <label for="editMediaFile" class="form-label"
              >Replace File (Optional)</label
            >
            <input
              type="file"
              class="form-control"
              id="editMediaFile"
              name="file"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SweetAlert2 for nice alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Edit Media Form Submission
  document
    .getElementById("editMediaForm")
    .addEventListener("submit", function (event) {
      // Only prevent default if we want to use AJAX instead of regular form submission
      event.preventDefault();

      // Ensure form has correct attributes
      if (!this.getAttribute("method")) {
        this.setAttribute("method", "POST");
      }
      if (!this.getAttribute("enctype")) {
        this.setAttribute("enctype", "multipart/form-data");
      }

      const mediaId = document.getElementById("editMediaId").value;

      // Set the correct action URL
      this.action = "/dashboard/media-library/edit/" + mediaId;

      const formData = new FormData(this);
      const submitButton = this.querySelector('button[type="submit"]');

      // Log form data for debugging
      console.log("Form data entries:");
      for (let pair of formData.entries()) {
        console.log(
          pair[0] + ": " + (pair[1] instanceof File ? pair[1].name : pair[1])
        );
      }

      submitButton.disabled = true;
      submitButton.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

      // Add a hidden field to indicate we want to redirect back to the media library
      const redirectField = document.createElement("input");
      redirectField.type = "hidden";
      redirectField.name = "redirect";
      redirectField.value = "true";
      this.appendChild(redirectField);

      // Submit the form traditionally
      this.submit();

      // Prevent further processing
      return false;
    });

  // Media Upload Form
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("addMediaForm");
    if (form) {
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> Uploading...';

        fetch("/dashboard/media-library/upload", {
          method: "POST",
          body: new FormData(this),
        })
          .then((response) => {
            if (
              response.headers.get("content-type")?.includes("application/json")
            ) {
              return response.json().then((data) => {
                if (data.success) {
                  Swal.fire({
                    title: "Success!",
                    text: data.message || "Media uploaded successfully",
                    icon: "success",
                    timer: 1500,
                    showConfirmButton: false,
                  }).then(() => {
                    window.location.href =
                      data.redirect || "/dashboard/media-library";
                  });
                } else {
                  throw new Error(data.message || "Upload failed");
                }
              });
            } else {
              // Redirect handler
              setTimeout(() => {
                window.location.href = "/dashboard/media-library";
              }, 1000);
            }
          })
          .catch((error) => {
            console.error("Upload error:", error);
            Swal.fire(
              "Error!",
              error.message || "Failed to upload media",
              "error"
            );
            submitBtn.disabled = false;
            submitBtn.innerHTML = "Upload";
          });
      });
    }
  });
</script>
